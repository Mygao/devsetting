#    Build centos7 image with gcc7 installed
#
#    Copyright (C) 2017 Gwangmin Lee
#    
#    Author: Gwangmin Lee <gwangmin0123@gmail.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

FROM gwangmin/centos_7_dev:latest

ARG CFLAGS="-O2 -pipe"

RUN export CLFAGS=$CFLAGS CXXFLAGS=$CFLAGS && \
        export VER="7_2_0" TEMP_DIR="/tmpgcc" && \
        export GCC_SOURCE_DIR="$TEMP_DIR/gcc-gcc-$VER-release" && \
        export GCC_BUILD_DIR="$TEMP_DIR/gcc-build" && \
        export GMP="gmp-6.1.2" MPFR="mpfr-3.1.6" MPC="mpc-1.0.3" ISL="isl-0.16.1" && \
        mkdir -p $TEMP_DIR && cd $TEMP_DIR && \
        curl -LO https://github.com/gcc-mirror/gcc/archive/gcc-$VER-release.zip && unzip gcc-$VER-release.zip && \
        cd $GCC_SOURCE_DIR && \
        curl -L https://gmplib.org/download/gmp/$GMP.tar.xz | tar xJf - && \
        curl -L http://www.mpfr.org/mpfr-current/$MPFR.tar.xz | tar xJf - && \
        curl -L ftp://ftp.gnu.org/gnu/mpc/$MPC.tar.gz | tar xzf - && \
        curl -L ftp://gcc.gnu.org/pub/gcc/infrastructure/$ISL.tar.bz2 | tar xjf - && \
        mv $GMP gmp && \
        mv $MPFR mpfr && \
        mv $MPC mpc && \
        mv $ISL isl && \
        mkdir $GCC_BUILD_DIR && \
        cd $GCC_BUILD_DIR && \
        $GCC_SOURCE_DIR/configure --prefix=/usr --disable-multilib --with-arch=core2 --with-language=c,c++,fortran,go && \
        make -j$(nproc) && \
        make install-strip && \
        rm -rf $TEMP_DIR

ENV LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:/usr/local/lib64:/usr/lib64
